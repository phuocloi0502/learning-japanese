<div class="container-fluid">
  <!-- Header + Statistics chung 1 n·ªÅn -->

  <div class="row mb-4">
    <div class="col-md-12">
      <div
        class="row g-0 align-items-center bg-light rounded-3 ps-4 mt-2"
        style="border-left: 6px solid #667eea; height: 85px; justify-content: center"
      >
        <div
          class="col-md-6 d-flex flex-row align-items-center justify-content-center"
          style="height: 80px"
        >
          <div
            class="me-3 d-flex align-items-center justify-content-center"
            style="font-size: 2.5rem; height: 80px"
          >
            üé¥
          </div>
          <div class="flex-grow-1 d-flex flex-column justify-content-center" style="height: 100%">
            <h2 class="fw-bold mb-1" style="font-size: 1.3rem; color: #333">
              {{ level }} - Ch∆∞∆°ng {{ chapterNumber }}- B√†i {{ lessonNumber }}
            </h2>
            <div class="lead text-muted mb-0" *ngIf="chapter && lesson" style="font-size: 1.1rem">
              {{ chapter.chapter_name }} - {{ lesson.lesson_name }}
            </div>
          </div>
        </div>
        <div
          class="col-md-6 d-flex flex-column justify-content-center align-items-end statistics-desktop"
          style="height: 80px"
        >
          <div
            class="d-flex flex-row w-100 mb-2 justify-content-center flex-wrap gap-lg-2"
            style="margin-bottom: 0 !important"
          >
            <button
              class="btn btn-action text-primary flex-fill"
              (click)="loadLessonData()"
              [class.active]="filterMode === 'all'"
            >
              <div class="stat-number">{{ totalCardsOfLesson }}</div>
              T·ªïng t·ª´
            </button>
            <button
              class="btn btn-action text-success flex-fill"
              (click)="listRememberedVocabulary(true)"
              [class.active]="filterMode === 'remembered'"
            >
              <div class="stat-number">{{ rememberedCards }}</div>
              ƒê√£ nh·ªõ
            </button>
            <button
              class="btn btn-action text-danger flex-fill"
              (click)="listRememberedVocabulary(false)"
              [class.active]="filterMode === 'notRemembered'"
            >
              <div class="stat-number">{{ notRememberedCards }}</div>
              Ch∆∞a nh·ªõ
            </button>
            <button class="btn btn-action text-info flex-fill">
              <div class="stat-number text-info">{{ getProgressPercentage() }}%</div>
              Ti·∫øn ƒë·ªô
            </button>
          </div>
          <div class="position-absolute start-0 m-3" style="top: 175px">
            <button class="btn btn-outline-secondary mt-3" (click)="goBack()">‚Üê Quay l·∫°i</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5>ƒêang t·∫£i d·ªØ li·ªáu...</h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="row">
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        {{ error }}
      </div>
    </div>
  </div>

  <!-- Flash Card -->
  <div *ngIf="!isLoading && !error && totalCardsCurrent > 0 && !isEnd" class="row">
    <div class="col-12">
      <div
        class="col-md-6 d-flex flex-column justify-content-center align-items-end statistics-mobile"
        style="height: 120px"
      >
        <div class="d-flex flex-row w-100 mb-2 justify-content-center flex-wrap gap-lg-5">
          <button
            class="btn btn-action text-primary flex-fill"
            (click)="loadLessonData()"
            [class.active]="filterMode === 'all'"
          >
            <div class="stat-number">{{ totalCardsOfLesson }}</div>
            T·ªïng t·ª´
          </button>
          <button
            class="btn btn-action text-success flex-fill"
            (click)="listRememberedVocabulary(true)"
            [class.active]="filterMode === 'remembered'"
          >
            <div class="stat-number">{{ rememberedCards }}</div>
            ƒê√£ nh·ªõ
          </button>
          <button
            class="btn btn-action text-danger flex-fill"
            (click)="listRememberedVocabulary(false)"
            [class.active]="filterMode === 'notRemembered'"
          >
            <div class="stat-number">{{ notRememberedCards }}</div>
            Ch∆∞a nh·ªõ
          </button>
          <button class="btn btn-action text-info flex-fill">
            <div class="stat-number text-info">{{ getProgressPercentage() }}%</div>
            Ti·∫øn ƒë·ªô
          </button>
        </div>
      </div>

      <div class="col-12 d-flex justify-content-center align-items-center gap-3 fs-4">
        <input
          class="form-check-input"
          type="checkbox"
          name="show-furigana"
          id="show-furigana"
          (change)="toggleFurigana($event)"
        />
        <label for="show-furigana">Hi·ªÉn th·ªã Furigana</label>
      </div>
      <div class="flashcard-container">
        <!-- Progress Bar -->
        {{ currentIndex + 1 }} / {{ totalCardsCurrent }}
        <div class="progress mb-4">
          <div
            class="progress-bar"
            role="progressbar"
            [style.width.%]="((currentIndex + 1) / totalCardsCurrent) * 100"
            [attr.aria-valuenow]="currentIndex + 1"
            aria-valuemin="0"
            [attr.aria-valuemax]="totalCardsOfLesson"
          ></div>
        </div>

        <!-- Card -->
        <div class="flashcard position-relative" (click)="toggleAnswer()">
          <div class="vocab-actions-flashcard position-absolute end-0 z-3 top-0 mt-lg-3 me-lg-3">
            <button
              *ngIf="getCurrentVocabulary()?.sound_url"
              class="btn btn-sm btn-outline-primary audio-btn"
              [class.playing]="isAudioPlaying()"
              (click)="playAudio(); $event.stopPropagation()"
              [title]="isAudioPlaying() ? 'T·∫°m d·ª´ng' : 'Nghe ph√°t √¢m'"
            >
              {{ getAudioButtonText() }}
            </button>
          </div>
          <div class="card-content">
            <div class="vocab-kanji">{{ getCurrentVocabulary()?.kanji }}</div>
            <div class="d-flex justify-content-center gap-3 align-items-center">
              <div class="vocab-furigana" *ngIf="showFurigana">
                {{ getCurrentVocabulary()?.furigana }}
              </div>
              <div class="vocab-han" *ngIf="showAnswer">
                {{ getCurrentVocabulary()?.han?.toUpperCase() }}
              </div>
            </div>

            <div class="vocab-answer" *ngIf="showAnswer">
              <div class="vocab-meaning">{{ getCurrentVocabulary()?.meaning }}</div>
              <div class="vocab-example" *ngIf="getCurrentVocabulary()?.example">
                <div
                  class="example-japanese"
                  [innerHTML]="getCurrentVocabulary()?.example | ruby"
                ></div>
                <!-- <div class="example-japanese">{{ getCurrentVocabulary()?.example }}</div> -->
                <div class="example-meaning">{{ getCurrentVocabulary()?.example_meaning }}</div>
              </div>
            </div>
            <!--             
            <div class="card-hint">
              {{ showAnswer ? 'üëÜ Nh·∫•n ƒë·ªÉ ·∫©n nghƒ©a' : 'üëÜ Nh·∫•n ƒë·ªÉ xem nghƒ©a' }}
            </div> -->
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="card-actions">
          <div class="row action-buttons-group-desktop">
            <div class="col-md-3">
              <button
                class="btn btn-action"
                (click)="previousCard()"
                [disabled]="currentIndex === 0"
              >
                ‚¨ÖÔ∏è Tr∆∞·ªõc
              </button>
            </div>
            <div class="col-md-6">
              <div class="action-buttons">
                <button
                  class="btn btn-action me-2 text-white"
                  style="background-color: green"
                  (click)="markAsRemembered()"
                >
                  ƒê√£ nh·ªõ
                </button>
                <button
                  class="btn btn-action text-white"
                  style="background-color: red"
                  (click)="markAsNotRemembered()"
                >
                  Ch∆∞a nh·ªõ
                </button>
              </div>
            </div>
            <div class="col-md-3">
              <button
                class="btn btn-action"
                (click)="nextCard()"
                [disabled]="currentIndex === vocabularyList.length - 1"
              >
                Ti·∫øp ‚û°Ô∏è
              </button>
            </div>
          </div>
          <div class="action-buttons-group-mobile">
            <div class="">
              <button
                class="btn btn-action"
                (click)="previousCard()"
                [disabled]="currentIndex === 0"
              >
                ‚¨ÖÔ∏è Tr∆∞·ªõc
              </button>
            </div>
            <div class="">
              <div class="action-buttons">
                <button
                  class="btn btn-action me-2 text-white"
                  style="background-color: green"
                  (click)="markAsRemembered()"
                >
                  ƒê√£ nh·ªõ
                </button>
                <button
                  class="btn btn-action text-white"
                  style="background-color: red"
                  (click)="markAsNotRemembered()"
                >
                  Ch∆∞a nh·ªõ
                </button>
              </div>
            </div>
            <div class="">
              <button
                class="btn btn-action"
                (click)="nextCard()"
                [disabled]="currentIndex === vocabularyList.length - 1"
              >
                Ti·∫øp ‚û°Ô∏è
              </button>
            </div>
          </div>
        </div>

        <!-- Authentication Notice -->
        <div *ngIf="!isAuthenticated" class="alert alert-info text-center mt-4">
          <h6>üîê ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn ƒë·ªô h·ªçc t·∫≠p</h6>
          <p>ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u tr·∫°ng th√°i "ƒë√£ nh·ªõ" v√† "ch∆∞a nh·ªõ" c·ªßa t·ª´ng t·ª´ v·ª±ng</p>
          <button class="btn btn-primary" (click)="goToLogin()">ƒêƒÉng nh·∫≠p ngay</button>
        </div>
      </div>
    </div>
  </div>

  <!-- No Data State -->
  <div *ngIf="!isLoading && !error && (isEnd || totalCardsCurrent === 0)" class="row">
    <div class="col-12">
      <div class="text-center">
        <h4 class="alert-heading">Kh√¥ng c√≥ t·ª´ v·ª±ng n√†o c·∫£</h4>

        <button class="btn btn-primary" (click)="loadLessonData()">H·ªçc l·∫°i</button>
      </div>
    </div>
  </div>
</div>
