<div class="container-fluid">
  <!-- Header -->
  <div class="row">
    <div class="col-12">
      <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <button class="btn btn-outline-secondary mb-2 mt-3" (click)="goBack()">
              ‚Üê Quay l·∫°i
            </button>
            <h1 class="display-5 fw-bold mb-0">
              üìö {{ level }} - Ch∆∞∆°ng {{ chapterNumber }} - B√†i {{ lessonNumber }}
            </h1>
            <p class="lead text-muted" *ngIf="chapter && lesson">
              {{ chapter.chapter_name }} - {{ lesson.lesson_name }}
            </p>
            <div class="d-flex gap-5">
              <div class="mt-3">
                <a
                  [routerLink]="['/flashcard', level, chapterNumber, lessonNumber]"
                  class="btn btn-primary"
                >
                  Luy·ªán t·∫≠p Flash Card
                </a>
              </div>
              <div class="mt-3">
                <a
                  [routerLink]="['/quizlet', level, chapterNumber, lessonNumber]"
                  class="btn btn-primary"
                >
                  Luy·ªán t·∫≠p tr·∫Øc nghi·ªám
                </a>
              </div>
              <div class="mt-3" *ngIf="isAdmin">
                <button class="btn btn-danger" (click)="handleAdminMode()">
                  {{ isAdminMode ? 'View' : 'Edit' }}
                </button>
              </div>
            </div>
            <!-- Audio Player -->
            <div class="mt-3">
              <button class="btn btn-outline-primary" (click)="playFullAudio()">
                {{ isFullPlaying ? '‚è∏Ô∏è To√†n b√†i' : '‚ñ∂Ô∏è To√†n b√†i' }}
              </button>
            </div>
          </div>
          <div class="text-end">
            <span class="badge bg-primary fs-6" *ngIf="vocabularyList.length > 0">
              {{ remembered }} / {{ vocabularyList.length }} t·ª´ v·ª±ng
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5>ƒêang t·∫£i t·ª´ v·ª±ng...</h5>
          <p class="text-muted">Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="row">
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">L·ªói!</h4>
        <p>{{ error }}</p>
        <hr />
        <button class="btn btn-outline-danger" (click)="goBack()">Quay l·∫°i trang t·ª´ v·ª±ng</button>
      </div>
    </div>
  </div>

  <!-- Main Content with Sidebar -->
  <div *ngIf="!isLoading && !error && vocabularyList.length > 0" class="row">
    <!-- Main Content -->
    <div class="col-lg-9 col-md-12">
      <div class="vocabulary-grid">
        <div class="vocabulary-card" *ngFor="let vocab of vocabularyList; let i = index">
          <div class="card h-100">
            <div class="card-body">
              <div class="vocab-header">
                <div class="vocab-number">{{ i + 1 }}</div>
                <div class="vocab-main">
                  <div
                    *ngIf="isEditMode && isAdmin && editingVocabularyItem === vocab; else viewKanji"
                  >
                    <input
                      [(ngModel)]="vocab.kanji"
                      [name]="'kanji-' + i"
                      class="form-control vocab-kanji"
                      placeholder="Kanji"
                    />
                  </div>
                  <ng-template #viewKanji>
                    <h3 class="vocab-kanji">{{ vocab.kanji }}</h3>
                  </ng-template>
                  <div
                    *ngIf="
                      isEditMode && isAdmin && editingVocabularyItem === vocab;
                      else viewFurigana
                    "
                  >
                    <input
                      [(ngModel)]="vocab.furigana"
                      [name]="'furigana-' + i"
                      class="form-control vocab-furigana"
                      placeholder="Furigana"
                    />
                  </div>
                  <ng-template #viewFurigana>
                    <div class="vocab-furigana">{{ vocab.furigana }}</div>
                  </ng-template>
                </div>
                <div class="vocab-actions">
                  <button
                    *ngIf="vocab.sound_url"
                    class="btn btn-sm btn-outline-primary audio-btn"
                    [class.playing]="isAudioPlaying(vocab.vocabulary_id)"
                    (click)="playAudio(vocab.sound_url, vocab.vocabulary_id)"
                    [title]="isAudioPlaying(vocab.vocabulary_id) ? 'T·∫°m d·ª´ng' : 'Nghe ph√°t √¢m'"
                  >
                    {{ getAudioButtonText(vocab.vocabulary_id) }}
                  </button>
                </div>
              </div>

              <div class="vocab-meaning">
                <div
                  *ngIf="isEditMode && isAdmin && editingVocabularyItem === vocab; else viewMeaning"
                >
                  <input
                    [(ngModel)]="vocab.meaning"
                    [name]="'meaning-' + i"
                    class="form-control"
                    placeholder="Meaning"
                  />
                </div>
                <ng-template #viewMeaning>
                  <strong>{{ vocab.meaning }}</strong>
                </ng-template>
              </div>
              <div class="vocab-example" *ngIf="vocab.example">
                <div
                  *ngIf="isAdmin && isEditMode && editingVocabularyItem === vocab; else viewExample"
                >
                  <input
                    [(ngModel)]="vocab.example"
                    [name]="'example-' + i"
                    class="form-control"
                    placeholder="Example"
                  />
                </div>
                <ng-template #viewExample>
                  <div class="example-japanese" [innerHTML]="vocab.example | ruby"></div>
                </ng-template>
                <div
                  *ngIf="
                    isAdmin && isEditMode && editingVocabularyItem === vocab;
                    else viewExampleMeaning
                  "
                >
                  <input
                    [(ngModel)]="vocab.example_meaning"
                    [name]="'example-meaning-' + i"
                    class="form-control"
                    placeholder="Example Meaning"
                  />
                </div>
                <ng-template #viewExampleMeaning>
                  <div class="example-meaning">{{ vocab.example_meaning }}</div>
                </ng-template>
              </div>
            </div>
            <div class="card-footer">
              <ng-container *ngIf="isEditMode && isAdmin && editingVocabularyItem === vocab">
                <button
                  class="btn btn-success"
                  type="button"
                  (click)="handleOpenSaveConfirm(vocab)"
                >
                  <i class="bi bi-check-circle-fill"></i>
                </button>
                <button class="btn btn-secondary mx-3" type="button" (click)="handleCancel()">
                  <i class="bi bi-x-circle"></i>
                </button>
              </ng-container>

              <ng-container *ngIf="isAdminMode && isAdmin && !isEditMode">
                <div class="d-flex justify-content-between">
                  <button class="btn btn-primary" type="button" (click)="setEditMode(vocab)">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <button
                    class="btn btn-secondary"
                    type="button"
                    (click)="handleOpenRollBackConfirm(vocab)"
                  >
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar - Desktop -->
    <div class="col-lg-3 d-none d-lg-block">
      <div class="sidebar">
        <div class="sidebar-header">
          <h5>üìö {{ level }} - T·∫•t c·∫£ b√†i h·ªçc</h5>
        </div>
        <div class="sidebar-content">
          <div class="chapter-list" *ngFor="let chapter of allChapters">
            <div class="chapter-item">
              <h6 class="chapter-title">
                üìñ Ch∆∞∆°ng {{ chapter.chapter_number }}: {{ chapter.chapter_name }}
              </h6>
              <ul class="lesson-list">
                <li *ngFor="let lesson of chapter.lessonList">
                  <a
                    [routerLink]="[
                      '/vocabulary',
                      level,
                      chapter.chapter_number,
                      lesson.lesson_number
                    ]"
                    class="lesson-link"
                    [class.active]="
                      chapter.chapter_number === chapterNumber &&
                      lesson.lesson_number === lessonNumber
                    "
                  >
                    <span class="lesson-number">{{ lesson.lesson_number }}.</span>
                    {{ lesson.lesson_name }}
                    <small class="text-muted">({{ lesson.vocabularyList.length }} t·ª´)</small>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Sidebar - Bottom -->
  <div *ngIf="!isLoading && !error && vocabularyList.length > 0" class="d-lg-none">
    <div class="mobile-sidebar">
      <div class="mobile-sidebar-header">
        <h5>üìö {{ level }} - T·∫•t c·∫£ b√†i h·ªçc</h5>
      </div>
      <div class="mobile-sidebar-content">
        <div class="chapter-list" *ngFor="let chapter of allChapters">
          <div class="chapter-item">
            <h6 class="chapter-title">
              üìñ Ch∆∞∆°ng {{ chapter.chapter_number }}: {{ chapter.chapter_name }}
            </h6>
            <ul class="lesson-list">
              <li *ngFor="let lesson of chapter.lessonList">
                <a
                  [routerLink]="[
                    '/vocabulary',
                    level,
                    chapter.chapter_number,
                    lesson.lesson_number
                  ]"
                  class="lesson-link"
                  [class.active]="
                    chapter.chapter_number === chapterNumber &&
                    lesson.lesson_number === lessonNumber
                  "
                >
                  <span class="lesson-number">{{ lesson.lesson_number }}.</span>
                  {{ lesson.lesson_name }}
                  <small class="text-muted">({{ lesson.vocabularyList.length }} t·ª´)</small>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No Data State -->
  <div *ngIf="!isLoading && !error && vocabularyList.length === 0" class="row">
    <div class="col-12">
      <div class="alert alert-info text-center" role="alert">
        <h4 class="alert-heading">Kh√¥ng c√≥ t·ª´ v·ª±ng</h4>
        <p>Kh√¥ng t√¨m th·∫•y t·ª´ v·ª±ng n√†o trong b√†i h·ªçc n√†y.</p>
        <button class="btn btn-outline-info" (click)="goBack()">Quay l·∫°i trang t·ª´ v·ª±ng</button>
      </div>
    </div>
  </div>
</div>
